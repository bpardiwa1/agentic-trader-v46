name: Deploy Agentic Trader V2 (Merged Envs on 9101‚Äì9103)

on:
  workflow_dispatch:

defaults:
  run:
    shell: powershell

env:
  TARGET_ROOT: 'C:\agentic-trader'
  PY_EXE: 'C:\Users\Administrator\AppData\Local\Programs\Python\Python311\python.exe'
  VENV_DIR: '.venv'

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure env directories exist
        run: |
          $envDir = Join-Path $env:TARGET_ROOT 'app\env'
          $mergedDir = Join-Path $envDir '.merged'
          New-Item -ItemType Directory -Force -Path $envDir | Out-Null
          New-Item -ItemType Directory -Force -Path $mergedDir | Out-Null

      - name: Recreate raw .env files from GitHub secrets
        run: |
          $envDir = Join-Path $env:TARGET_ROOT 'app\env'
          [IO.File]::WriteAllText((Join-Path $envDir 'core.env'),    "${{ secrets.CORE_ENV }}")
          [IO.File]::WriteAllText((Join-Path $envDir 'fx.env'),      "${{ secrets.FX_ENV }}")
          [IO.File]::WriteAllText((Join-Path $envDir 'indices.env'), "${{ secrets.INDICES_ENV }}")
          [IO.File]::WriteAllText((Join-Path $envDir 'xau.env'),     "${{ secrets.XAU_ENV }}")
          Write-Host "‚úÖ Raw environment files created."

      - name: Merge core + asset envs
        run: |
          function Merge-EnvFiles($core, $asset, $output) {
            $coreLines  = Get-Content $core | Where-Object {$_ -and ($_ -notmatch '^#')}
            $assetLines = Get-Content $asset | Where-Object {$_ -and ($_ -notmatch '^#')}
            $merged = @($coreLines; ""; $assetLines)
            Set-Content -Path $output -Value $merged -Encoding UTF8
            Write-Host "Merged -> $output"
          }

          $envDir = Join-Path $env:TARGET_ROOT 'app\env'
          $mergedDir = Join-Path $envDir '.merged'

          Merge-EnvFiles "$envDir\core.env" "$envDir\fx.env"      "$mergedDir\env_FX_merged.env"
          Merge-EnvFiles "$envDir\core.env" "$envDir\indices.env" "$mergedDir\env_INDEX_merged.env"
          Merge-EnvFiles "$envDir\core.env" "$envDir\xau.env"     "$mergedDir\env.XAU.merged.env"

          Write-Host "‚úÖ All merged envs created."

      - name: Create venv and install dependencies
        run: |
          $VenvPath = Join-Path $env:TARGET_ROOT $env:VENV_DIR
          if (Test-Path $VenvPath) { Remove-Item -Recurse -Force $VenvPath }
          & $env:PY_EXE -m venv $VenvPath
          & "$VenvPath\Scripts\pip" install --upgrade pip
          & "$VenvPath\Scripts\pip" install -r requirements.txt

      - name: Launch FX Bot (port 9101)
        run: |
          $cmd = "$env:TARGET_ROOT\$env:VENV_DIR\Scripts\python.exe"
          Start-Process -NoNewWindow $cmd -ArgumentList "-m uvicorn app.main:app --host 127.0.0.1 --port 9101 --env-file app/env/.merged/env.FX.merged.env"
          Write-Host "üöÄ FX bot started on port 9101"

      - name: Launch XAU Bot (port 9102)
        run: |
          $cmd = "$env:TARGET_ROOT\$env:VENV_DIR\Scripts\python.exe"
          Start-Process -NoNewWindow $cmd -ArgumentList "-m uvicorn app.main:app --host 127.0.0.1 --port 9102 --env-file app/env/.merged/env.XAU.merged.env"
          Write-Host "üöÄ XAU bot started on port 9102"

      - name: Launch Indices Bot (port 9103)
        run: |
          $cmd = "$env:TARGET_ROOT\$env:VENV_DIR\Scripts\python.exe"
          Start-Process -NoNewWindow $cmd -ArgumentList "-m uvicorn app.main:app --host 127.0.0.1 --port 9103 --env-file app/env/.merged/env.INDEX.merged.env"
          Write-Host "üöÄ Indices bot started on port 9103"
function gitupdate {
    Write-Host "üîÑ Syncing with GitHub main branch..." -ForegroundColor Cyan
    try {
        git pull origin main --rebase
        if ($LASTEXITCODE -eq 0) {
            git push origin main
            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ GitHub sync successful!" -ForegroundColor Green
            } else {
                Write-Host "‚ö†Ô∏è Push failed ‚Äî check for authentication issues." -ForegroundColor Yellow
            }
        } else {
            Write-Host "‚ö†Ô∏è Pull failed ‚Äî please fix merge conflicts first." -ForegroundColor Red
        }
    } catch {
        Write-Host "‚ùå Error during gitupdate execution: $_" -ForegroundColor Red
    }
}


