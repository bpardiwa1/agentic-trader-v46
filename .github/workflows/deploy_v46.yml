name: Deploy Agentic Trader v4.6 (Sync + Build venv only)

on:
  workflow_dispatch:   # Manual trigger from GitHub Actions tab

defaults:
  run:
    shell: powershell

env:
  TARGET_ROOT: 'C:\agentic-trader'
  PY_EXE: 'C:\Users\Administrator\AppData\Local\Programs\Python\Python311\python.exe'
  VENV_DIR: '.venv'

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # --------------------------------------------------------
      # Checkout latest repository
      # --------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Sync repository to live folder
      # --------------------------------------------------------
      - name: Sync repository to live folder
        run: |
          Write-Host "Syncing repository to $env:TARGET_ROOT ..."
          robocopy $PWD $env:TARGET_ROOT /MIR /XD ".git" ".github" ".vscode" "__pycache__" "logs"
          $exitCode = $LASTEXITCODE
          if ($exitCode -le 7) {
            Write-Host "Repository synchronized to $env:TARGET_ROOT (exit code: $exitCode)"
            exit 0
          } else {
            Write-Host "Robocopy failed (exit code: $exitCode)"
            exit $exitCode
          }

      # --------------------------------------------------------
      # Build or Refresh Python virtual environment
      # --------------------------------------------------------
      - name: Build Python virtual environment
        run: |
          cd $env:TARGET_ROOT
          if (Test-Path $env:VENV_DIR) {
            Write-Host "Removing existing virtual environment..."
            Remove-Item -Recurse -Force $env:VENV_DIR
          }
          Write-Host "Creating new virtual environment..."
          & $env:PY_EXE -m venv $env:VENV_DIR
          & "$env:VENV_DIR\Scripts\pip.exe" install --upgrade pip
          & "$env:VENV_DIR\Scripts\pip.exe" install -r requirements.txt
          Write-Host "Python environment ready."
