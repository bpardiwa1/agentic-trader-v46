name: Deploy Agentic Trader V46 (Service Restart Mode)

on:
  workflow_dispatch:

defaults:
  run:
    shell: powershell

env:
  TARGET_ROOT: 'C:\agentic-trader'
  PY_EXE: 'C:\Users\Administrator\AppData\Local\Programs\Python\Python311\python.exe'
  VENV_DIR: '.venv'

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # -----------------------------
      # Checkout latest repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Sync repository to live folder
      # -----------------------------
      - name: Sync repository to live folder
        run: |
         Write-Host "Syncing repository to $env:TARGET_ROOT ..."
         robocopy $PWD $env:TARGET_ROOT /MIR /XD ".git" ".github" ".vscode" "__pycache__"
         $exitCode = $LASTEXITCODE
         if ($exitCode -le 7) {
            Write-Host "Repository synchronized to $env:TARGET_ROOT. (Robocopy exit code: $exitCode)"
            exit 0
         } else {
             Write-Host "Robocopy failed with exit code: $exitCode"
             exit $exitCode
         }


      # -----------------------------
      # Stop running bot services
      # -----------------------------
      - name: Stop existing Agentic Trader services
        run: |
         Write-Host "Stopping running services..."
        # C:\nssm\nssm-2.24\win64\nssm stop AgenticTrader_FX -ErrorAction SilentlyContinue
        # C:\nssm\nssm-2.24\win64\nssm stop AgenticTrader_INDEX -ErrorAction SilentlyContinue
        # C:\nssm\nssm-2.24\win64\nssm stop AgenticTrader_XAU -ErrorAction SilentlyContinue
         Start-Sleep -Seconds 5
         Write-Host "All services stopped successfully." 

      # -----------------------------
      # Rebuild Python virtual environment
      # -----------------------------
      - name: Rebuild virtual environment
        run: |
          cd $env:TARGET_ROOT
          if (Test-Path $env:VENV_DIR) {
            Write-Host "Removing existing virtual environment..."
            Remove-Item -Recurse -Force $env:VENV_DIR
          }
          Write-Host "Creating new virtual environment..."
          & $env:PY_EXE -m venv $env:VENV_DIR
          & "$env:VENV_DIR\Scripts\pip" install --upgrade pip
          & "$env:VENV_DIR\Scripts\pip" install -r requirements.txt
          $exitCode = $LASTEXITCODE
           if ($exitCode -le 7) {
            Write-Host "Virtual Environment Created. (exit code: $exitCode)"
            exit 0
            } else {
             Write-Host "Robocopy failed with exit code: $exitCode"
             exit $exitCode
           }

      # -----------------------------
      # Restart services after deployment
      # -----------------------------
      - name: Start updated Agentic Trader services
        run: |
         Write-Host "Starting updated services..."
         # C:\nssm\nssm-2.24\win64\nssm start AgenticTrader_FX
         # C:\nssm\nssm-2.24\win64\nssm start AgenticTrader_INDEX
         # C:\nssm\nssm-2.24\win64\nssm start AgenticTrader_XAU
         Write-Host "Services started successfully."

      # -----------------------------
      # Verify service status
      # -----------------------------
      - name: Verify service status
        run: |
         Write-Host "`nVerifying service status..."
           # C:\nssm\nssm-2.24\win64\nssm status AgenticTrader_FX
           # C:\nssm\nssm-2.24\win64\nssm status AgenticTrader_INDEX
           # C:\nssm\nssm-2.24\win64\nssm status AgenticTrader_XAU
         Write-Host "`nDeployment completed successfully."
